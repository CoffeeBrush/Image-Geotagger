name: Build Release EXE

on:
  push:
    branches:
      - test-signing
  release:
    types: [published, created]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Clean old build artifacts
        run: |
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }

      - name: Build one-folder Image Geotagger EXE from spec file
        run: |
          pyinstaller "Image Geotagger.spec"

      - name: Copy bin folder
        run: |
          Copy-Item -Path "bin" -Destination "dist\Image Geotagger\bin" -Recurse -Force

      - name: Setup signing tools via NuGet
        run: |
          $toolsDir = "$env:RUNNER_TEMP\signtool_tools"
          New-Item -ItemType Directory -Path $toolsDir -Force | Out-Null
          
          $nugetUrl = "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe"
          $nugetPath = "$toolsDir\nuget.exe"
          Invoke-WebRequest -Uri $nugetUrl -OutFile $nugetPath -UseBasicParsing
          
          & $nugetPath install Microsoft.Windows.SDK.BuildTools `
            -Version 10.0.26100.7463 `
            -OutputDirectory "$toolsDir\packages" `
            -NonInteractive
          
          Write-Output "SIGNTOOL_DIR=$toolsDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Code sign application EXE
        run: |
          $signtoolPath = "$env:SIGNTOOL_DIR\packages\Microsoft.Windows.SDK.BuildTools.10.0.26100.7463\bin\10.0.26100.0\x64\signtool.exe"
          if (-not (Test-Path $signtoolPath)) {
            throw "signtool.exe not found at: $signtoolPath"
          }

          $pfxPath = "$env:RUNNER_TEMP\cert.pfx"
          $pfxBytes = [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX }}")
          [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)

          & $signtoolPath sign `
            /fd SHA256 `
            /f $pfxPath `
            /p "${{ secrets.CODESIGN_PASSWORD }}" `
            /t http://timestamp.sectigo.com `
            "dist\Image Geotagger\Image Geotagger.exe"

          Remove-Item $pfxPath

      # ---------------- INSTALLER CREATION ----------------

      - name: Install Inno Setup
        run: |
          choco install innosetup --no-progress -y

      - name: Build installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

      - name: Sign installer
        run: |
          $signtoolPath = "$env:SIGNTOOL_DIR\packages\Microsoft.Windows.SDK.BuildTools.10.0.26100.7463\bin\10.0.26100.0\x64\signtool.exe"
          if (-not (Test-Path $signtoolPath)) {
            throw "signtool.exe not found at: $signtoolPath"
          }

          $pfxPath = "$env:RUNNER_TEMP\cert.pfx"
          $pfxBytes = [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX }}")
          [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)

          & $signtoolPath sign `
            /fd SHA256 `
            /f $pfxPath `
            /p "${{ secrets.CODESIGN_PASSWORD }}" `
            /t http://timestamp.sectigo.com `
            "installer\Image Geotagger Setup.exe"

          Remove-Item $pfxPath

      # ---------------- RELEASE ----------------

      - name: Upload installer to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: "installer/Image Geotagger Setup.exe"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
