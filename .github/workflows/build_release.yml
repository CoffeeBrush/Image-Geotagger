name: Build Release EXE

on:
  release:
    types: [published, created]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Clean old build artifacts
        run: |
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }

      - name: Build one-file Image Geotagger EXE from spec file
        run: |
          pyinstaller "Image Geotagger.spec"

      - name: Create release folder structure
        run: |
          New-Item -ItemType Directory -Path "dist\Image Geotagger" -Force
          Move-Item "dist\Image Geotagger.exe" "dist\Image Geotagger\"

      - name: Copy bin folder
        run: |
          Copy-Item -Path "bin" -Destination "dist\Image Geotagger\bin" -Recurse -Force

      - name: Zip release folder
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          $zip = "dist\Image_Geotagger_$tag.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Compress-Archive -Path "dist\Image Geotagger\*" -DestinationPath $zip

      - name: Upload ZIP to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Image_Geotagger_${{ github.event.release.tag_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
