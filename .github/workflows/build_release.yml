name: Build Release EXE

on:
  push:
    branches:
      - test-signing
  release:
    types: [published, created]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Clean old build artifacts
        run: |
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }

      - name: Build one-folder Image Geotagger EXE from spec file
        run: |
          pyinstaller "Image Geotagger.spec"

      - name: Copy bin folder
        run: |
          Copy-Item -Path "bin" -Destination "dist\Image Geotagger\bin" -Recurse -Force

      - name: Setup signing tools
        run: |
          # Try to find signtool if already installed
          $signtool = Get-Command signtool.exe -ErrorAction SilentlyContinue
          if ($signtool) {
            Write-Host "signtool already found at: $($signtool.Source)"
            exit 0
          }
          
          # Install Windows SDK with just the signing tools
          choco install windows-sdk-10-version-22621 -y --no-progress

      - name: Code sign executable
        run: |
          $pfxPath = "$env:RUNNER_TEMP\cert.pfx"
          $pfxBytes = [System.Convert]::FromBase64String("${{ secrets.CODESIGN_PFX }}")
          [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
          
          # Find signtool
          $signtoolPaths = @(
            "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe",
            "C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe",
            "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\signtool.exe"
          )
          
          $signtoolPath = $null
          foreach ($path in $signtoolPaths) {
            if (Test-Path $path) {
              $signtoolPath = $path
              Write-Host "Found signtool at: $path"
              break
            }
          }
          
          if (-not $signtoolPath) {
            # Last resort: search the entire Program Files
            $signtoolPath = Get-ChildItem -Path "C:\Program Files (x86)" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
            if ($signtoolPath) {
              Write-Host "Found signtool via search at: $signtoolPath"
            }
          }
          
          if (-not $signtoolPath) {
            throw "signtool.exe not found anywhere on the system"
          }
          
          & $signtoolPath sign /f $pfxPath /p "${{ secrets.CODESIGN_PASSWORD }}" /t http://timestamp.sectigo.com "dist\Image Geotagger\Image Geotagger.exe"
          
          Remove-Item $pfxPath

      - name: Create ZIP
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          $zip = "dist\Image_Geotagger_$tag.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Compress-Archive -Path "dist\Image Geotagger\*" -DestinationPath $zip

      - name: Upload ZIP to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Image_Geotagger_${{ github.event.release.tag_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
